require("dotenv").config();
const puppeteer = require("puppeteer");

const SELECTOR_LOGIN_NAME = 'input[name="username"]';
const SELECTOR_LOGIN_PASSWORD = 'input[type="password"]';
const SELECTOR_LOGIN_SUBMIT = '#login input[type="submit"]';

const SELECTOR_ACP_NAME = 'input[name="username"]';
const SELECTOR_ACP_PASSWORD = 'input[type="password"]';
const SELECTOR_ACP_SUBMIT = '#login input[type="submit"]';

const SELECTOR_JOINED_BEFORE = "#joined_before";
const SELECTOR_POST_COUNT = "#count";
const SELECTOR_DELETE_POSTS = 'input[name="deleteposts"][value="1"]';
const SELECTOR_DELETE_USERS = 'input[name="action"][value="delete"]';
const SELECTOR_PRUNE_SUBMIT = '#acp_prune input[type="submit"]';

(async () => {
  const browser = await puppeteer.launch({ headless: false });
  const page = await browser.newPage();

  await login(page);
  const userSid = await getQueryParam(page, "sid");
  console.log(`Logged into forum. sid: ${userSid}`);

  await loginToAdmin(page, userSid);
  const adminSid = await getQueryParam(page, "sid");
  console.log(`Logged into ACP. sid: ${adminSid}`);

  await loopPruneUsers(page, adminSid);

  //   await browser.close();

  process.on("SIGINT", async () => {
    console.log("Closing Chrome manually.");
    try {
      await browser.close();
      process.exit();
    } catch (e) {
      console.log(e);
      process.exit();
    }
  });
})();

/**
 * Login to the forum (as a regular user)
 */
async function login(page) {
  await page.goto(`${process.env.FORUM_URL}/ucp.php?mode=login`);

  await page.click(SELECTOR_LOGIN_NAME);
  await page.keyboard.type(process.env.USERNAME);

  await page.click(SELECTOR_LOGIN_PASSWORD);
  await page.keyboard.type(process.env.PASSWORD);

  await page.click(SELECTOR_LOGIN_SUBMIT);
  return await page.waitForNavigation();
}

/**
 * Access the ACP.
 *
 * @param {*} page Puppeteer object.
 * @param {string} sid  Access token generated by phpbb after login.
 */
async function loginToAdmin(page, sid) {
  await page.goto(`${process.env.FORUM_URL}/adm/index.php?sid=${sid}`);

  await page.click(SELECTOR_ACP_PASSWORD);
  await page.keyboard.type(process.env.PASSWORD);

  await page.click(SELECTOR_ACP_SUBMIT);
  return await page.waitForNavigation();
}

/**
 * Repeatedly submit the "Prune" form for each day between the given range.
 *
 * @param {*} page Puppeteer object.
 * @param {string} sid  Admin access token generated by phpbb after ACP login.
 * @param {Date} from   First "Joined Before" date to start with.
 * @param {Date} to     Final "Joined Before" date to end with (i.e. no users who joined after this will be deleted)
 */
async function loopPruneUsers(page, sid, from, to) {
  return pruneUsers(page, sid, from);
}

/**
 * Start the user prune process.
 *
 * @param {*} page Puppeteer object.
 * @param {string} sid  Admin access token generated by phpbb after ACP login.
 */
async function pruneUsers(page, sid, date) {
  await page.goto(
    `${process.env.FORUM_URL}/adm/index.php?sid=${sid}&i=acp_prune&mode=users`
  );

  await page.click(SELECTOR_JOINED_BEFORE);
  await page.keyboard.type("2009-03-02");

  await page.click(SELECTOR_POST_COUNT);
  await page.keyboard.type("0");

  await page.click(SELECTOR_DELETE_POSTS);
  await page.click(SELECTOR_DELETE_USERS);

  await page.click(SELECTOR_PRUNE_SUBMIT);
  return await page.waitForNavigation();
}

/**
 * Get a query param from the current URL.
 *
 * @param {*} page Puppeteer object.
 * @param {string} name  Name of the param to retrieve.
 */
async function getQueryParam(page, name) {
  return page.$eval(
    "body",
    (body, name) => {
      const url = location.search;
      name = name.replace(/[\[\]]/g, "\\$&");
      const regex = new RegExp("[?&]" + name + "(=([^&#]*)|&|#|$)");
      const results = regex.exec(url);
      if (!results) return null;
      if (!results[2]) return "";
      return decodeURIComponent(results[2].replace(/\+/g, " "));
    },
    name
  );
}
